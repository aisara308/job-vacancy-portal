<!DOCTYPE html>
<html lang="kk" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Жауаптар беті</title>
    <link rel="stylesheet" th:href="@{/css/response.css}">
</head>
<body>

<div class="tabs">
    <button class="tab active" data-tab="all">Барлығы</button>
    <button class="tab" data-tab="waiting">Жауап күтуде</button>
    <button class="tab" data-tab="rejected">Бас тартылды</button>
    <button class="tab" data-tab="interview">Сұхбат</button>
    <button class="tab" data-tab="invited">Шақыру</button>
</div>

<div id="all" class="content"><div class="cards"></div></div>
<div id="waiting" class="content hidden"><div class="cards"></div></div>
<div id="rejected" class="content hidden"><div class="cards"></div></div>
<div id="interview" class="content hidden"><div class="cards"></div></div>
<div id="invited" class="content hidden"><div class="cards"></div></div>

<script>
    const token = localStorage.getItem("token");
    if (!token) {
        alert("Кіру қажет!");
        window.location.href = "/login";
    }

    // Вкладки переключение
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.content');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            contents.forEach(c => c.classList.add('hidden'));
            const target = document.getElementById(tab.dataset.tab);
            if (target) target.classList.remove('hidden');
        });
    });

async function loadApplications() {
    try {
        const res = await fetch("/applications/my", {
            headers: { "Authorization": "Bearer " + token }
        });
        const applications = await res.json();

        const statusMap = {
            pending: "waiting",
            rejected: "rejected",
            interview: "interview",
            invited: "invited"
        };

        const containers = {
    all: document.querySelector("#all .cards"),
    waiting: document.querySelector("#waiting .cards"),
    rejected: document.querySelector("#rejected .cards"),
    interview: document.querySelector("#interview .cards"),
    invited: document.querySelector("#invited .cards")
};

        // Очистка контейнеров перед добавлением карточек
        Object.values(containers).forEach(c => c.innerHTML = "");

        if (applications.length === 0) {
            containers.all.innerHTML = `<h2>Осы бет бос</h2>
                <p>Сізге арналған вакансиялар тізімін қарап шығыңыз</p>
                <a th:href="@{/home}" class="btn">Вакансия іздеу</a>`;
        }

        // Пробегаемся по всем откликам
        for (const app of applications) {
            let vacancyData = {};
            if (app.vacancyId) {
                try {
                    const vacRes = await fetch(`/vacancies/${app.vacancyId}`, {
                        headers: { "Authorization": "Bearer " + token }
                    });
                    if (vacRes.ok) {
                        vacancyData = await vacRes.json();
                    }
                } catch (err) {
                    console.warn("Вакансия табылмады для id:", app.vacancyId);
                }
            }

            const card = document.createElement("div");
            card.className = "application-card";

            let statusText = "";
            if (app.status === "pending") statusText = "Жауап күтуде";
            else if (app.status === "rejected") statusText = "Бас тартылды";
            else if (app.status === "interview") statusText = "Сұхбат";
            else statusText = "Шақыру";

            card.innerHTML = `
                <div class="status-label ${app.status}">${statusText}</div>
                <h4>${vacancyData.title || app.vacancyTitle || "Вакансия"}</h4>
                <p>${vacancyData.adres || app.adres || ""}, ${vacancyData.location || app.location || ""}</p>
                <p>${vacancyData.salaryFrom || vacancyData.salaryTo ?
                    "Жалақы: " + (vacancyData.salaryFrom || "") + " - " + (vacancyData.salaryTo || "") : ""}</p>
                <p class="date">${app.appliedAt ? new Date(app.appliedAt).toLocaleDateString("kk-KZ") : ""}</p>
            `;

            containers.all.appendChild(card.cloneNode(true));
            const tabId = statusMap[app.status];
            if (tabId) containers[tabId].appendChild(card.cloneNode(true));
        }

    } catch (err) {
        console.error(err);
        alert("Қате! Жауаптар жүктелмеді.");
    }
}
    loadApplications();
</script>

<link rel="stylesheet" th:href="@{/css/footer.css}">
<div th:replace="index :: footer"></div>
</body>
</html>
