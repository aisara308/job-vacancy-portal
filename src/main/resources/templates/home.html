<!DOCTYPE html>
<html lang="kk" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Вакансиялар</title>
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" th:href="@{/css/home.css}" />
</head>
<body>

<header class="top-bar">
    <h2 class="logo">Вакансиялар</h2>
    <div class="search-bar">
        <input type="text" placeholder="Іздеу...">
        <button class="search-btn"><img th:src="@{/images/searchRed.png}" alt="Іздеу" class="icon"></button>
        <button class="filter-btn"><img th:src="@{/images/filter.png}" alt="Фильтр" class="icon"></button>
    </div>
</header>

<main class="vacancies-container"></main>

<div th:replace="index :: footer"></div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("token");

      if (!token) {
        alert("Кіру қажет!");
        window.location.href = "/login";
        return;
      }

      let vacancies = [];
      const container = document.querySelector(".vacancies-container");

      try {
        const response = await fetch("/api/home", {
          headers: {
            "Authorization": "Bearer " + token
          }
        });

        if (!response.ok) {
          console.error("Ошибка при загрузке вакансий:", response.status);
          if (response.status === 403 || response.status === 401) {
            alert("Сессия аяқталды. Қайта кіріңіз.");
            localStorage.removeItem("token");
            window.location.href = "/login";
          }
          return;
        }

        const data = await response.json();
        vacancies = data.vacancies || [];
        renderVacancies(vacancies);

      } catch (error) {
        console.error("Қате:", error);
        alert("Сервермен байланыс үзілді. Кейінірек қайталаңыз.");
      }

      const searchInput = document.querySelector(".search-bar input");
      const searchBtn = document.querySelector(".search-btn");

      searchBtn.addEventListener("click", () => {
        const query = searchInput.value.trim().toLowerCase();
        const filtered = vacancies.filter(vac => vac.title.toLowerCase().includes(query));
        renderVacancies(filtered);
      });
      searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          searchBtn.click();
        }
      });

      function renderVacancies(list) {
        container.innerHTML = "";
        if (list.length === 0) {
          container.innerHTML = "<p style='text-align:center;color:#333;'>Вакансия табылмады.</p>";
          return;
        }

        list.forEach(vac => {
          const card = document.createElement("div");
          card.className = "vacancy-card";
          card.innerHTML = `
            <div class="vacancy-header">
                <span class="icon"><img src="/images/job.png" alt="Вакансия" class="icon"></span>
                <h3>${vac.title}</h3>
                <span class="like"><button class="like-btn"><img src="/images/thumbUp.png" alt="Фильтр" class="icon"></button></span>
            </div>
            <p class="date">Соңғы өзгеріс: ${vac.createdAt ? vac.createdAt.substring(0, 10) : "-"}</p>
            <p class="company"><img src="/images/address.png" alt="Адрес" class="icon"> ${vac.adres}, Астана</p>
            <div class="tags">
                ${vac.forStudents ? "<span>Студенттерге арналған</span>" : ""}
                ${vac.remote ? "<span>Қашықтан</span>" : ""}
            </div>
            <div class="salary">
              ${vac.salaryFrom ? vac.salaryFrom + " ₸" : ""}
              ${vac.salaryTo ? " – " + vac.salaryTo + " ₸" : ""}
            </div>
            <p class="responses"><span>0</span> адам жауап берді</p>
            <button class="apply-btn">Жауап беру ➤</button>
          `;
          container.appendChild(card);
        });
      }

    });
</script>
</body>
</html>
