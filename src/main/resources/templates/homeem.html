<!DOCTYPE html>
<html lang="kk" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Резюмелер</title>
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" th:href="@{/css/home.css}" />
</head>
<body>

<header class="top-bar">
    <h2 class="logo">Резюмелер</h2>
    <div class="search-bar">
        <input type="text" placeholder="Іздеу...">
        <button class="search-btn"><img th:src="@{/images/searchRed.png}" alt="Іздеу" class="icon"></button>
        <button class="filter-btn"><img th:src="@{/images/filter.png}" alt="Фильтр" class="icon"></button>
    </div>
</header>

<div id="vacancySelectModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeVacancyModal">&times;</span>
        <h3>Сіздің вакансияңызды таңдаңыз</h3>
        <div id="vacancyOptions"></div>
        <button id="submitVacancyChoice">Жіберу</button>
    </div>
</div>

<div id="resumeViewModal" class="modal">
    <div class="resume-modal-content">
        <div class="resume-modal-header">
            <h2 id="modalResumeTitle"></h2>
            <span class="close" id="closeResumeViewModal">&times;</span>
        </div>

        <div class="resume-modal-body">
            <div class="info-grid">
                <div class="info-item">
                    <label>Локация</label>
                    <p id="modalResumeLocation"></p>
                </div>

                <div class="info-item">
                    <label>Тәжірибе</label>
                    <p id="modalResumeExperience"></p>
                </div>

                <div class="info-item">
                    <label>Білім</label>
                    <p id="modalResumeEducation"></p>
                </div>

                <div class="info-item">
                    <label>Жұмыс кестесі</label>
                    <p id="modalResumeSchedule"></p>
                </div>

                <div class="info-item">
                    <label>Жалақы</label>
                    <p id="modalResumeSalary" class="salary"></p>
                </div>
            </div>

            <div class="description-block">
                <label>Дағдылар / Сипаттама</label>
                <p id="modalResumeDescription"></p>
            </div>
        </div>
    </div>
</div>

<main class="vacancies-container"></main>

<div th:replace="navigation :: footer"></div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("token");

        if (!token) {
            alert("Кіру қажет!");
            window.location.href = "/login";
            return;
        }

        let resumes = [];
        let currentUser = null;
        const container = document.querySelector(".vacancies-container");

        // Получаем данные текущего пользователя
        try {
            const userRes = await fetch("/api/user", {
                headers: { "Authorization": "Bearer " + token }
            });

            if (!userRes.ok) {
                throw new Error("Не удалось получить данные пользователя");
            }

            currentUser = await userRes.json();
        } catch (error) {
            console.error("Ошибка при загрузке пользователя:", error);
        }

        // Загрузка резюме
        try {
            const response = await fetch("/api/homeem", {
                headers: { "Authorization": "Bearer " + token }
            });

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    alert("Сессия аяқталды. Қайта кіріңіз.");
                    localStorage.removeItem("token");
                    window.location.href = "/login";
                }
                return;
            }

            const data = await response.json();
            resumes = data.resumes || [];

            // Загружаем счетчики для всех резюме и рендерим
            await renderResumes(resumes);

        } catch (err) {
            console.error("Қате:", err);
            alert("Сервермен байланыс үзілді. Кейінірек қайталаңыз.");
        }

        // Поиск по резюме
        const searchInput = document.querySelector(".search-bar input");
        const searchBtn = document.querySelector(".search-btn");

        searchBtn.addEventListener("click", () => {
            const query = searchInput.value.trim().toLowerCase();
            const filtered = resumes.filter(res =>
                (res.title || res.user?.fullName || "").toLowerCase().includes(query)
            );
            renderResumes(filtered);
        });

        searchInput.addEventListener("keypress", e => {
            if (e.key === "Enter") searchBtn.click();
        });

        // Функция открытия модального окна просмотра резюме
        window.openResumeViewModal = function(resume) {
            document.getElementById("modalResumeTitle").textContent = resume.title || "-";
            document.getElementById("modalResumeLocation").textContent = resume.location || "-";
            document.getElementById("modalResumeExperience").textContent =
                resume.experience ? resume.experience + " жыл" : "-";
            document.getElementById("modalResumeEducation").textContent = resume.education || "-";
            document.getElementById("modalResumeSchedule").textContent = resume.schedule || "-";
            document.getElementById("modalResumeSalary").textContent =
                resume.salaryExpectation ? resume.salaryExpectation + " ₸" : "-";
            document.getElementById("modalResumeDescription").textContent =
                resume.skills || "Сипаттама жоқ";

            document.getElementById("resumeViewModal").style.display = "flex";
        };

        // Закрытие модальных окон
        document.getElementById("closeResumeViewModal").onclick = () => {
            document.getElementById("resumeViewModal").style.display = "none";
        };

        document.getElementById("closeVacancyModal").onclick = () => {
            document.getElementById("vacancySelectModal").style.display = "none";
        };

        // Закрытие по клику вне модального окна
        window.addEventListener("click", (e) => {
            const resumeModal = document.getElementById("resumeViewModal");
            const vacancyModal = document.getElementById("vacancySelectModal");

            if (e.target === resumeModal) {
                resumeModal.style.display = "none";
            }
            if (e.target === vacancyModal) {
                vacancyModal.style.display = "none";
            }
        });

        // Функция для получения количества приглашений
        async function getInvitationsCount(resumeId) {
            try {
                const response = await fetch(`/invitations/count/${resumeId}`, {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (response.ok) {
                    return await response.json();
                }
                return 0;
            } catch (error) {
                console.error(`Ошибка при получении количества приглашений для резюме ${resumeId}:`, error);
                return 0;
            }
        }

        // Функция отображения резюме
        async function renderResumes(list) {
            container.innerHTML = "";
            if (list.length === 0) {
                container.innerHTML = "<p style='text-align:center;color:#333;'>Резюме табылмады.</p>";
                return;
            }

            // Загружаем счетчики для всех резюме параллельно
            const resumesWithCounts = await Promise.all(
                list.map(async (res) => {
                    const resumeId = res.resumeId || res.id;
                    const count = await getInvitationsCount(resumeId);
                    return { ...res, invitationsCount: count };
                })
            );

            resumesWithCounts.forEach(res => {
                const resumeId = res.resumeId || res.id;

                const card = document.createElement("div");
                card.className = "vacancy-card";

                // Клик по карточке для просмотра резюме
                card.addEventListener("click", (e) => {
                    // Не открываем модалку если клик по кнопке "Байланысу"
                    if (!e.target.closest(".apply-btn") && !e.target.closest(".like-btn")) {
                        openResumeViewModal(res);
                    }
                });

                card.innerHTML = `
                    <div class="vacancy-header">
                        <span class="icon"><img src="/images/user.png" alt="Резюме" class="icon"></span>
                        <h3>${res.title || res.user?.fullName || "-"}</h3>
                        <span class="like"><button class="like-btn"><img src="/images/thumbUp.png" alt="Лайк" class="icon"></button></span>
                    </div>
                    <p class="date">Соңғы өзгеріс: ${res.createdAt ? res.createdAt.substring(0,10) : "-"}</p>
                    <p class="company"><img src="/images/address.png" alt="Қала" class="icon"> ${res.location || "-"}</p>
                    <div class="tags">
                        ${res.education?.toLowerCase().includes("студент") ? "<span>Студент</span>" : ""}
                        ${res.schedule?.toLowerCase().includes("қашықтан") ? "<span>Қашықтан</span>" : ""}
                    </div>
                    <div class="salary">
                        ${res.salaryExpectation ? res.salaryExpectation + " ₸" : ""}
                    </div>
                    <p class="responses"><span>${res.invitationsCount}</span> компания шақырды</p>
                    <button class="apply-btn" data-resume-id="${resumeId}">Байланысу ➤</button>
                `;

                container.appendChild(card);
            });

            // Добавляем обработчики для кнопок "Байланысу"
            attachApplyHandlers();
        }

        // Обработка кнопок "Байланысу"
        async function attachApplyHandlers() {
            const applyButtons = document.querySelectorAll(".apply-btn");

            applyButtons.forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    e.stopPropagation(); // Предотвращаем открытие модалки просмотра

                    const currentResumeId = btn.getAttribute("data-resume-id");

                    if (!currentUser) {
                        alert("Қолданушы деректері жүктелмеді");
                        return;
                    }

                    try {
                        // Получаем вакансии текущего пользователя
                        const vacRes = await fetch(`/vacancies/user/${currentUser.userId}`, {
                            headers: { "Authorization": "Bearer " + token }
                        });

                        if (!vacRes.ok) {
                            alert("Жүктеу кезінде қате.");
                            return;
                        }

                        const vacancies = await vacRes.json();

                        if (vacancies.length === 0) {
                            alert("Сізде вакансия жоқ. Алдымен вакансия қосыңыз.");
                            return;
                        }

                        // Показываем модалку с вакансиями
                        const modal = document.getElementById("vacancySelectModal");
                        const optionsContainer = document.getElementById("vacancyOptions");
                        modal.style.display = "flex";

                        optionsContainer.innerHTML = "";
                        vacancies.forEach((v, i) => {
                            const title = v.title || `Вакансия ${i+1}`;
                            const div = document.createElement("div");
                            div.textContent = title;
                            div.className = "resume-option";
                            div.dataset.index = i;
                            div.dataset.vacancyId = v.vacancyId || v.id;

                            div.addEventListener("click", () => {
                                document.querySelectorAll(".resume-option").forEach(el => el.classList.remove("selected"));
                                div.classList.add("selected");
                            });

                            optionsContainer.appendChild(div);
                        });

                        // Обработка отправки выбора
                        document.getElementById("submitVacancyChoice").onclick = async () => {
                            const selected = document.querySelector(".resume-option.selected");
                            if (!selected) {
                                alert("Вакансия таңдаңыз!");
                                return;
                            }

                            const vacancyId = selected.dataset.vacancyId;

                            if (!vacancyId || !currentResumeId) {
                                alert("Ошибка: ID вакансии или резюме не найден");
                                return;
                            }

                            try {
                                const response = await fetch("/invitations/add", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "Authorization": "Bearer " + token
                                    },
                                    body: JSON.stringify({
                                        resumeId: Number(currentResumeId),
                                        vacancyId: Number(vacancyId)
                                    })
                                });

                                const responseText = await response.text();

                                if (!response.ok) {
                                    alert("Қате: " + responseText);
                                    return;
                                }

                                alert("Сәтті өтініш жіберілді!");
                                modal.style.display = "none";

                                // Обновляем счетчик для этого резюме
                                const updatedCount = await getInvitationsCount(currentResumeId);
                                const countSpan = btn.closest(".vacancy-card")?.querySelector(".responses span");
                                if (countSpan) {
                                    countSpan.textContent = updatedCount;
                                }

                            } catch (fetchError) {
                                console.error("Ошибка при отправке запроса:", fetchError);
                                alert("Сервер қатесі: " + fetchError.message);
                            }
                        };

                    } catch (err) {
                        console.error("Ошибка в обработчике:", err);
                        alert("Сервер қатесі.");
                    }
                });
            });
        }
    });
</script>

</body>
</html>