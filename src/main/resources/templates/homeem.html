<!DOCTYPE html>
<html lang="kk" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Резюмелер</title>
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" th:href="@{/css/home.css}" />
</head>
<body>

<header class="top-bar">
    <h2 class="logo">Резюмелер</h2>
    <div class="search-bar">
        <input type="text" placeholder="Іздеу...">
        <button class="search-btn"><img th:src="@{/images/searchRed.png}" alt="Іздеу" class="icon"></button>
        <button class="filter-btn"><img th:src="@{/images/filter.png}" alt="Фильтр" class="icon"></button>
    </div>
</header>

<div id="resumeModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" id="closeResumeModal">&times;</span>
        <h3>Сіздің вакансияңызды таңдаңыз</h3>
        <div id="resumeOptions"></div>
        <button id="submitResumeChoice">Жіберу</button>
    </div>
</div>

<main class="vacancies-container"></main>

<div th:replace="navigation :: footer"></div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("token");
        if (!token) {
            alert("Кіру қажет!");
            window.location.href = "/login";
            return;
        }

        let resumes = [];
        const container = document.querySelector(".vacancies-container");

        // ===== Загрузка резюме =====
        try {
            const response = await fetch("/api/homeem", {
                headers: { "Authorization": "Bearer " + token }
            });

            if (!response.ok) {
                console.error("Ошибка при загрузке:", response.status);
                if (response.status === 401 || response.status === 403) {
                    alert("Сессия аяқталды. Қайта кіріңіз.");
                    localStorage.removeItem("token");
                    window.location.href = "/login";
                }
                return;
            }

            const data = await response.json();
            resumes = data.resumes || [];
            renderResumes(resumes);

        } catch (err) {
            console.error("Қате:", err);
            alert("Сервермен байланыс үзілді. Кейінірек қайталаңыз.");
        }

        // ===== Поиск по резюме =====
        const searchInput = document.querySelector(".search-bar input");
        const searchBtn = document.querySelector(".search-btn");

        searchBtn.addEventListener("click", () => {
            const query = searchInput.value.trim().toLowerCase();
            const filtered = resumes.filter(res =>
                (res.title || res.user?.fullName || "").toLowerCase().includes(query)
            );
            renderResumes(filtered);
        });

        searchInput.addEventListener("keypress", e => { if (e.key === "Enter") searchBtn.click(); });

        // ===== Функция отображения резюме =====
        function renderResumes(list) {
            container.innerHTML = "";
            if (list.length === 0) {
                container.innerHTML = "<p style='text-align:center;color:#333;'>Резюме табылмады.</p>";
                return;
            }

            list.forEach(res => {
                // Используем resumeId если есть, иначе id
                const resumeId = res.resumeId || res.id;

                const card = document.createElement("div");
                card.className = "vacancy-card";
                card.innerHTML = `
                    <div class="vacancy-header">
                        <span class="icon"><img src="/images/user.png" alt="Резюме" class="icon"></span>
                        <h3>${res.title || res.user?.fullName || "-"}</h3>
                        <span class="like"><button class="like-btn"><img src="/images/thumbUp.png" alt="Лайк" class="icon"></button></span>
                    </div>
                    <p class="date">Соңғы өзгеріс: ${res.createdAt ? res.createdAt.substring(0,10) : "-"}</p>
                    <p class="company"><img src="/images/address.png" alt="Қала" class="icon"> ${res.location || "-"}</p>
                    <div class="tags">
                        ${res.education?.toLowerCase().includes("студент") ? "<span>Студент</span>" : ""}
                        ${res.schedule?.toLowerCase().includes("қашықтан") ? "<span>Қашықтан</span>" : ""}
                    </div>
                    <div class="salary">
                        ${res.salaryExpectation ? res.salaryExpectation + " ₸" : ""}
                    </div>
                    <p class="responses"><span>0</span> компания қызықтырады</p>
                    <button class="apply-btn"
                            data-resume-id="${resumeId}"
                            data-applicant-id="${res.user?.id}">Байланысу ➤</button>
                `;
                container.appendChild(card);
            });

            attachApplyHandlers();
        }

        // ===== Функция обработки кнопок "Байланысу" =====
        async function attachApplyHandlers() {
            const userRes = await fetch("/api/user", {
                headers: { "Authorization": "Bearer " + token }
            });

            if (!userRes.ok) {
                alert("Сессия аяқталды. Қайта кіріңіз.");
                localStorage.removeItem("token");
                window.location.href = "/login";
                return;
            }

            const user = await userRes.json();
            const userId = user.userId;

            const applyButtons = document.querySelectorAll(".apply-btn");
            applyButtons.forEach(btn => {
                btn.addEventListener("click", async () => {
                    const currentResumeId = btn.getAttribute("data-resume-id");
                    console.log("Resume ID из атрибута:", currentResumeId);

                    try {
                        // Получаем вакансии текущего пользователя (работодателя)
                        const vacRes = await fetch(`/vacancies/user/${userId}`, {
                            headers: { "Authorization": "Bearer " + token }
                        });

                        if (!vacRes.ok) {
                            alert("Жүктеу кезінде қате.");
                            return;
                        }

                        const vacancies = await vacRes.json();
                        console.log("Все вакансии пользователя:", vacancies);

                        if (vacancies.length === 0) {
                            alert("Сізде вакансия жоқ. Алдымен вакансия қосыңыз.");
                            return;
                        }

                        // Проверяем структуру первой вакансии
                        if (vacancies.length > 0) {
                            console.log("Структура вакансии:", vacancies[0]);
                            console.log("Поля вакансии:", Object.keys(vacancies[0]));
                            console.log("vacancyId:", vacancies[0].vacancyId);
                            console.log("id:", vacancies[0].id);
                        }

                        // Показ модалки
                        const modal = document.getElementById("resumeModal");
                        const optionsContainer = document.getElementById("resumeOptions");
                        modal.style.display = "flex";

                        optionsContainer.innerHTML = "";
                        vacancies.forEach((v, i) => {
                            // Используем title или название вакансии
                            const title = v.title || `Вакансия ${i+1}`;
                            const div = document.createElement("div");
                            div.textContent = title;
                            div.className = "resume-option";
                            div.dataset.index = i;
                            div.addEventListener("click", () => {
                                document.querySelectorAll(".resume-option").forEach(el => el.classList.remove("selected"));
                                div.classList.add("selected");
                            });
                            optionsContainer.appendChild(div);
                        });

                        // Закрытие модалки
                        document.getElementById("closeResumeModal").onclick = () => {
                            modal.style.display = "none";
                        };

                        modal.onclick = e => {
                            if(e.target === modal) modal.style.display = "none";
                        };

                        document.getElementById("submitResumeChoice").onclick = async () => {
                            const selected = document.querySelector(".resume-option.selected");
                            if (!selected) {
                                alert("Вакансия таңдаңыз!");
                                return;
                            }

                            const selectedVacancy = vacancies[selected.dataset.index];
                            console.log("Выбранная вакансия:", selectedVacancy);

                            // Определяем правильное поле ID вакансии
                            const vacancyIdValue = selectedVacancy.vacancyId || selectedVacancy.id;
                            console.log("ID вакансии для отправки:", vacancyIdValue);

                            // Проверяем, что ID не undefined
                            if (!vacancyIdValue) {
                                alert("Ошибка: ID вакансии не найден");
                                console.error("Вакансия не содержит ID:", selectedVacancy);
                                return;
                            }

                            // Проверяем, что resumeId существует
                            if (!currentResumeId) {
                                alert("Ошибка: ID резюме не найден");
                                return;
                            }

                            // Преобразуем в числа
                            const resumeIdNum = Number(currentResumeId);
                            const vacancyIdNum = Number(vacancyIdValue);

                            console.log("Отправляемые данные:", {
                                resumeId: resumeIdNum,
                                vacancyId: vacancyIdNum
                            });

                            console.log("Типы данных:", {
                                resumeId: typeof resumeIdNum,
                                vacancyId: typeof vacancyIdNum,
                                resumeIdIsNaN: isNaN(resumeIdNum),
                                vacancyIdIsNaN: isNaN(vacancyIdNum)
                            });

                            if (isNaN(resumeIdNum) || isNaN(vacancyIdNum)) {
                                alert("Ошибка: некорректные ID");
                                return;
                            }

                            try {
                                const response = await fetch("/invitations/add", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "Authorization": "Bearer " + token
                                    },
                                    body: JSON.stringify({
                                        resumeId: resumeIdNum,
                                        vacancyId: vacancyIdNum
                                    })
                                });

                                const responseText = await response.text();
                                console.log("Ответ сервера:", responseText);

                                if (!response.ok) {
                                    alert("Қате: " + responseText);
                                    return;
                                }

                                alert("Сәтті өтініш жіберілді!");
                                modal.style.display = "none";

                            } catch (fetchError) {
                                console.error("Ошибка при отправке запроса:", fetchError);
                                alert("Сервер қатесі: " + fetchError.message);
                            }
                        };

                    } catch (err) {
                        console.error("Ошибка в обработчике:", err);
                        alert("Сервер қатесі.");
                    }
                });
            });
        }

    });
</script>

</body>
</html>