<!DOCTYPE html>
<html lang="kk" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Жауаптар беті</title>
    <link rel="stylesheet" th:href="@{/css/response.css}">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>

<div class="tabs">
    <button class="tab active" data-tab="all">Барлығы</button>
    <button class="tab" data-tab="pending">Жауап күтуде</button>
    <button class="tab" data-tab="interview">Сұхбат</button>
    <button class="tab" data-tab="invited">Шақыру</button>
</div>

<div id="all" class="content"><div class="cards"></div></div>
<div id="pending" class="content hidden"><div class="cards"></div></div>
<div id="interview" class="content hidden"><div class="cards"></div></div>
<div id="invited" class="content hidden"><div class="cards"></div></div>

<!-- Модальное окно для просмотра резюме -->
<div id="resumeModal" class="modal" style="display: none;">
    <div class="resume-modal-content">
        <div class="resume-modal-header">
            <h2 id="modalTitle"></h2>
            <span class="close" onclick="closeResumeModal()">&times;</span>
        </div>

        <div class="resume-modal-body">
            <div class="info-grid">
                <div class="info-item">
                    <label>Локация</label>
                    <p id="modalLocation"></p>
                </div>

                <div class="info-item">
                    <label>Тәжірибе</label>
                    <p id="modalExperience"></p>
                </div>

                <div class="info-item">
                    <label>Білім</label>
                    <p id="modalEducation"></p>
                </div>

                <div class="info-item">
                    <label>Жұмыс кестесі</label>
                    <p id="modalSchedule"></p>
                </div>

                <div class="info-item">
                    <label>Жалақы</label>
                    <p id="modalSalary" class="salary"></p>
                </div>
            </div>

            <div class="description-block">
                <label>Дағдылар / Сипаттама</label>
                <p id="modalDescription"></p>
            </div>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem("token");
    if (!token) {
        alert("Кіру қажет!");
        window.location.href = "/login";
    }

    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.content');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            contents.forEach(c => c.classList.add('hidden'));
            const target = document.getElementById(tab.dataset.tab);
            if (target) target.classList.remove('hidden');
        });
    });

    // Кэш для пользовательских данных
    const userCache = new Map();
    // Кэш для резюме
    const resumeCache = new Map();

    // Функция для получения имени пользователя по ID
    async function getUserNameById(userId) {
        if (!userId) return "Атауы жоқ";

        // Проверяем кэш
        if (userCache.has(userId)) {
            return userCache.get(userId);
        }

        try {
            const response = await fetch(`/api/user/${userId}`, {
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                }
            });

            if (response.ok) {
                const userData = await response.json();

                // Пробуем получить имя из разных полей
                const userName = userData.name || userData.fullName || userData.username || userData.email || `Пайдаланушы №${userId}`;

                // Сохраняем в кэш
                userCache.set(userId, userName);
                return userName;
            } else {
                console.warn(`User not found, status: ${response.status} for ID ${userId}`);
                const fallbackName = `Пайдаланушы №${userId}`;
                userCache.set(userId, fallbackName);
                return fallbackName;
            }
        } catch (err) {
            console.error(`Error loading user data for ID ${userId}:`, err);
            return `Пайдаланушы №${userId}`;
        }
    }

    // Функция для перехода в чат
    async function goToChat(userId) {
        console.log("goToChat called with userId:", userId);

        if (!userId) {
            console.error("User ID is missing");
            alert("Чат ашу үшін пайдаланушы ID көрсетілмеген");
            return;
        }

        try {
            console.log("Creating/getting chat with user:", userId);

            const response = await fetch(`/api/chat/get-or-create?user2Id=${userId}`, {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error("Chat creation failed:", errorText);
                alert("Чат ашылмады");
                return;
            }

            const chat = await response.json();
            console.log("Chat created/retrieved:", chat);

            // Переход на страницу чата
            window.location.href = `/chat/${chat.chatId}`;

        } catch (error) {
            console.error("Chat error:", error);
            alert("Қате орын алды");
        }
    }

    // Функция для открытия модального окна с резюме
    function openResumeModal(resume) {
        if (!resume) {
            console.error("Resume data is null or undefined");
            alert("Резюме туралы мәліметтер жоқ");
            return;
        }

        if (Object.keys(resume).length === 0) {
            console.error("Resume data is empty");
            alert("Резюме деректері бос");
            return;
        }

        try {
            document.getElementById("modalTitle").textContent = resume.title || "Атаусыз резюме";
            document.getElementById("modalLocation").textContent = resume.location || "-";
            document.getElementById("modalExperience").textContent = resume.experience ? resume.experience + " жыл" : "-";
            document.getElementById("modalEducation").textContent = resume.education || "-";
            document.getElementById("modalSchedule").textContent = resume.schedule || "-";
            document.getElementById("modalSalary").textContent = resume.salaryExpectation ? resume.salaryExpectation + " ₸" : "-";
            document.getElementById("modalDescription").textContent = resume.skills || resume.description || "Сипаттама жоқ";

            const modal = document.getElementById("resumeModal");

            if (modal) {
                modal.style.display = "flex";
            } else {
                console.error("Modal element not found!");
            }
        } catch (error) {
            console.error("Error opening modal:", error);
            alert("Модальдық терезені ашу кезінде қате пайда болды");
        }
    }

    function closeResumeModal() {
        const modal = document.getElementById("resumeModal");
        if (modal) {
            modal.style.display = "none";
        }
    }

    window.onclick = function(event) {
        const modal = document.getElementById("resumeModal");
        if (event.target === modal) {
            modal.style.display = "none";
        }
    }

    async function updateStatus(applicationId, newStatus) {
        console.log("Updating status - ID:", applicationId, "New status:", newStatus);

        try {
            const res = await fetch(`/applications/${applicationId}/status`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({ status: newStatus })
            });

            console.log("Response status:", res.status);

            if (!res.ok) {
                const text = await res.text();
                console.log("Error response:", text);
                throw new Error("Ошибка обновления: " + res.status);
            }

            // После успешного обновления перезагружаем данные
            await loadEmployerApplications();

        } catch (error) {
            console.error("Error updating status:", error);
            alert("Статусты өзгерту кезінде қате пайда болды");
        }
    }

    async function loadResumeDetails(resumeId) {
        if (!resumeId) {
            console.warn("No resume ID provided");
            return null;
        }

        // Проверяем кэш резюме
        if (resumeCache.has(resumeId)) {
            console.log("Using cached resume data for ID:", resumeId);
            return resumeCache.get(resumeId);
        }

        try {
            console.log("Loading resume details for ID:", resumeId);
            const res = await fetch(`/resume/get/${resumeId}`, {
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                }
            });

            if (res.ok) {
                const data = await res.json();
                console.log("Resume data loaded:", data);
                // Сохраняем в кэш
                resumeCache.set(resumeId, data);
                return data;
            } else {
                console.warn("Resume not found, status:", res.status);
                const errorText = await res.text();
                console.warn("Error response:", errorText);
                return null;
            }
        } catch (err) {
            console.error("Error loading resume:", err);
            return null;
        }
    }

    // Функция для получения userId из различных источников
    function extractUserId(resumeData, app) {
        console.log("Extracting userId from resumeData:", resumeData);
        console.log("Extracting userId from app:", app);

        // 1. Проверяем resumeData.user?.userId (из логов видно, что user содержит userId)
        if (resumeData?.user?.userId) {
            console.log("Found userId in resumeData.user.userId:", resumeData.user.userId);
            return resumeData.user.userId;
        }

        // 2. Проверяем resumeData.user?.id
        if (resumeData?.user?.id) {
            console.log("Found userId in resumeData.user.id:", resumeData.user.id);
            return resumeData.user.id;
        }

        // 3. Проверяем resumeData.userId
        if (resumeData?.userId) {
            console.log("Found userId in resumeData.userId:", resumeData.userId);
            return resumeData.userId;
        }

        // 4. Проверяем app.userId
        if (app?.userId) {
            console.log("Found userId in app.userId:", app.userId);
            return app.userId;
        }

        // 5. Проверяем app.user?.id
        if (app?.user?.id) {
            console.log("Found userId in app.user.id:", app.user.id);
            return app.user.id;
        }

        // 6. Проверяем app.user?.userId
        if (app?.user?.userId) {
            console.log("Found userId in app.user.userId:", app.user.userId);
            return app.user.userId;
        }

        console.log("No userId found in any source");
        return null;
    }

    async function createApplicationCard(app, resumeData) {
        const card = document.createElement("div");
        card.className = "application-card";
        card.style.cursor = "pointer";

        // Получаем userId
        const userId = extractUserId(resumeData, app);

        // Получаем имя пользователя
        let userName = "Атауы жоқ";
        if (resumeData?.user?.name) {
            userName = resumeData.user.name;
        } else if (resumeData?.user?.fullName) {
            userName = resumeData.user.fullName;
        } else if (resumeData?.user?.username) {
            userName = resumeData.user.username;
        } else if (app?.userName) {
            userName = app.userName;
        } else if (userId) {
            // Если есть userId, но нет имени, пробуем загрузить имя
            getUserNameById(userId).then(name => {
                // Обновляем имя в карточке если нужно
                const nameElement = card.querySelector('.user-name');
                if (nameElement) {
                    nameElement.textContent = name;
                }
            });
            userName = `Пайдаланушы №${userId}`;
        }

        console.log("Application card - User ID:", userId, "User Name:", userName, "Status:", app.status);

        card.setAttribute('data-application-id', app.applicationId);
        card.setAttribute('data-resume-id', app.resumeId || '');
        card.setAttribute('data-user-id', userId || '');
        card.setAttribute('data-user-name', userName);

        if (resumeData) {
            card.setAttribute('data-resume-data', JSON.stringify(resumeData));
        }

        let statusText = "";
        if (app.status === "pending") statusText = "Жауап күтуде";
        else if (app.status === "interview") statusText = "Сұхбат";
        else statusText = "Қабылданбады";

        const salaryText = resumeData?.salaryExpectation
            ? Number(resumeData.salaryExpectation).toLocaleString() + " ₸"
            : "Көрсетілмеген";

        // Чат батырмасының HTML коды - ТЕК ЕСЛИ userId БАР
        let chatButtonHtml = "";
        if (app.status === "interview") {
            if (userId) {
                chatButtonHtml = `
                    <button class="chat-btn" data-user-id="${userId}">
                        Чатқа өту
                    </button>
                `;
                console.log("Chat button WILL BE SHOWN for user:", userId);
            } else {
                console.log("Chat button NOT shown - no userId for application:", app.applicationId);
            }
        }

        card.innerHTML = `
            <div class="status-label ${app.status}">${statusText}</div>
            <h4>${resumeData?.title || "Вакансия"}</h4>
            <p><strong>Жұмыс іздеуші:</strong> <span class="user-name">${userName}</span></p>
            <p><strong>Күтілетін жалақы:</strong> ${salaryText}</p>
            <p><strong>Локация:</strong> ${resumeData?.location || "Көрсетілмеген"}</p>
            <p class="date">${app.appliedAt ? new Date(app.appliedAt).toLocaleDateString("kk-KZ") : ""}</p>

            ${app.status === "pending" ? `
                <div class="action-buttons">
                    <button class="accept-btn" data-app-id="${app.applicationId}">Қабылдау</button>
                    <button class="reject-btn" data-app-id="${app.applicationId}">Қабылдамау</button>
                </div>
            ` : ""}

            ${chatButtonHtml}
        `;

        // Добавляем обработчик клика на карточку
        card.addEventListener('click', async function(event) {
            // Если клик был по кнопке, не открываем модальное окно
            if (event.target.tagName === 'BUTTON') {
                return;
            }

            const resumeId = this.getAttribute('data-resume-id');
            const resumeDataJson = this.getAttribute('data-resume-data');

            if (resumeDataJson) {
                try {
                    const resumeData = JSON.parse(resumeDataJson);
                    openResumeModal(resumeData);
                } catch (e) {
                    console.error("Error parsing resume data:", e);

                    if (resumeId && resumeId !== '') {
                        const resumeData = await loadResumeDetails(resumeId);
                        if (resumeData) {
                            openResumeModal(resumeData);
                        }
                    }
                }
            } else if (resumeId && resumeId !== '') {
                const resumeData = await loadResumeDetails(resumeId);
                if (resumeData) {
                    openResumeModal(resumeData);
                }
            }
        });

        // Добавляем обработчики для кнопок
        if (app.status === "pending") {
            const acceptBtn = card.querySelector(".accept-btn");
            const rejectBtn = card.querySelector(".reject-btn");

            if (acceptBtn) {
                acceptBtn.addEventListener("click", async (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    await updateStatus(app.applicationId, "interview");
                });
            }

            if (rejectBtn) {
                rejectBtn.addEventListener("click", async (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    await updateStatus(app.applicationId, "rejected");
                });
            }
        }

        // Кнопка чата үшін бөлек обработчик
        if (app.status === "interview" && userId) {
            const chatBtn = card.querySelector(".chat-btn");
            if (chatBtn) {
                chatBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    const targetUserId = chatBtn.getAttribute('data-user-id');
                    console.log("Chat button clicked, userId:", targetUserId);
                    goToChat(targetUserId);
                });
            }
        }

        return card;
    }

    async function createInvitationCard(inv, resumeData) {
        const card = document.createElement("div");
        card.className = "application-card";
        card.style.cursor = "pointer";

        // Получаем userId
        const userId = extractUserId(resumeData, inv);

        // Получаем имя пользователя
        let userName = "Атауы жоқ";
        if (resumeData?.user?.name) {
            userName = resumeData.user.name;
        } else if (resumeData?.user?.fullName) {
            userName = resumeData.user.fullName;
        } else if (resumeData?.user?.username) {
            userName = resumeData.user.username;
        } else if (inv?.userName) {
            userName = inv.userName;
        } else if (userId) {
            getUserNameById(userId).then(name => {
                const nameElement = card.querySelector('.user-name');
                if (nameElement) {
                    nameElement.textContent = name;
                }
            });
            userName = `Пайдаланушы №${userId}`;
        }

        console.log("Invitation card - User ID:", userId, "User Name:", userName);

        card.setAttribute('data-resume-id', inv.resumeId || '');
        card.setAttribute('data-user-id', userId || '');
        card.setAttribute('data-user-name', userName);

        if (resumeData) {
            card.setAttribute('data-resume-data', JSON.stringify(resumeData));
        }

        const salaryText = resumeData?.salaryExpectation
            ? Number(resumeData.salaryExpectation).toLocaleString() + " ₸"
            : "Көрсетілмеген";

        card.innerHTML = `
            <div class="status-label invited">Шақыру</div>
            <h4>${resumeData?.title || "Вакансия"}</h4>
            <p><strong>Жұмыс іздеуші:</strong> <span class="user-name">${userName}</span></p>
            <p><strong>Күтілетін жалақы:</strong> ${salaryText}</p>
            <p><strong>Локация:</strong> ${resumeData?.location || "Көрсетілмеген"}</p>
            <p class="date">${inv.sentAt ? new Date(inv.sentAt).toLocaleDateString("kk-KZ") : ""}</p>
        `;

        card.addEventListener('click', async function(event) {
            const resumeId = this.getAttribute('data-resume-id');
            const resumeDataJson = this.getAttribute('data-resume-data');

            if (resumeDataJson) {
                try {
                    const resumeData = JSON.parse(resumeDataJson);
                    openResumeModal(resumeData);
                } catch (e) {
                    console.error("Error parsing resume data:", e);

                    if (resumeId && resumeId !== '') {
                        const resumeData = await loadResumeDetails(resumeId);
                        if (resumeData) {
                            openResumeModal(resumeData);
                        }
                    }
                }
            } else if (resumeId && resumeId !== '') {
                const resumeData = await loadResumeDetails(resumeId);
                if (resumeData) {
                    openResumeModal(resumeData);
                }
            }
        });

        return card;
    }

    async function loadEmployerApplications() {
        try {
            console.log("Loading employer applications...");

            const appRes = await fetch("/vacancies/applications/my", {
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                }
            });

            if (!appRes.ok) {
                const errorText = await appRes.text();
                console.error("Error loading applications:", errorText);
                throw new Error("Failed to load applications");
            }

            const applications = await appRes.json();
            console.log("Applications loaded:", applications);

            const invRes = await fetch("/invitations/my", {
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                }
            });

            let invitations = [];
            if (invRes.ok) {
                invitations = await invRes.json();
                console.log("Invitations loaded:", invitations);
            } else {
                console.warn("Could not load invitations, status:", invRes.status);
            }

            const containers = {
                all: document.querySelector("#all .cards"),
                pending: document.querySelector("#pending .cards"),
                interview: document.querySelector("#interview .cards"),
                invited: document.querySelector("#invited .cards"),
            };

            Object.values(containers).forEach(c => {
                if (c) c.innerHTML = "";
            });

            const allItems = [];

            // Создаем карточки для заявок
            if (applications && applications.length > 0) {
                for (const app of applications) {
                    let resumeData = null;
                    if (app.resumeId) {
                        resumeData = await loadResumeDetails(app.resumeId);
                    }

                    const card = await createApplicationCard(app, resumeData);
                    allItems.push({ card, status: app.status });
                }
            } else {
                console.log("No applications found");
            }

            // Создаем карточки для приглашений
            if (invitations && invitations.length > 0) {
                for (const inv of invitations) {
                    let resumeData = null;
                    if (inv.resumeId) {
                        resumeData = await loadResumeDetails(inv.resumeId);
                    }

                    const card = await createInvitationCard(inv, resumeData);
                    allItems.push({ card, status: "invited" });
                }
            } else {
                console.log("No invitations found");
            }

            // Заполняем контейнеры
            if (allItems.length === 0) {
                containers.all.innerHTML = `<h2>Қазіргі уақытта өтініштер жоқ</h2>`;
            } else {
                allItems.forEach(item => {
                    // Клонируем карточку для вкладки "Все"
                    const cloneForAll = item.card.cloneNode(true);

                    // Добавляем обработчики для клонированной карточки
                    if (item.status === "pending") {
                        const acceptBtn = cloneForAll.querySelector(".accept-btn");
                        const rejectBtn = cloneForAll.querySelector(".reject-btn");

                        if (acceptBtn) {
                            acceptBtn.addEventListener("click", async (e) => {
                                e.stopPropagation();
                                e.preventDefault();
                                const appId = acceptBtn.getAttribute('data-app-id');
                                await updateStatus(appId, "interview");
                            });
                        }

                        if (rejectBtn) {
                            rejectBtn.addEventListener("click", async (e) => {
                                e.stopPropagation();
                                e.preventDefault();
                                const appId = rejectBtn.getAttribute('data-app-id');
                                await updateStatus(appId, "rejected");
                            });
                        }
                    }

                    // Чат батырмасы үшін обработчик
                    const chatBtn = cloneForAll.querySelector(".chat-btn");
                    if (chatBtn) {
                        chatBtn.addEventListener("click", (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            const userId = chatBtn.getAttribute('data-user-id');
                            console.log("Clone chat button clicked, userId:", userId);
                            goToChat(userId);
                        });
                    }

                    // Добавляем обработчик клика для клонированной карточки
                    cloneForAll.addEventListener('click', async function(event) {
                        if (event.target.tagName === 'BUTTON') return;

                        const resumeId = this.getAttribute('data-resume-id');
                        const resumeDataJson = this.getAttribute('data-resume-data');

                        if (resumeDataJson) {
                            try {
                                const resumeData = JSON.parse(resumeDataJson);
                                openResumeModal(resumeData);
                            } catch (e) {
                                console.error("Error parsing resume data:", e);

                                if (resumeId && resumeId !== '') {
                                    const resumeData = await loadResumeDetails(resumeId);
                                    if (resumeData) {
                                        openResumeModal(resumeData);
                                    }
                                }
                            }
                        } else if (resumeId && resumeId !== '') {
                            const resumeData = await loadResumeDetails(resumeId);
                            if (resumeData) {
                                openResumeModal(resumeData);
                            }
                        }
                    });

                    containers.all.appendChild(cloneForAll);

                    // Добавляем оригинальную карточку в соответствующую вкладку
                    if (item.status && containers[item.status]) {
                        containers[item.status].appendChild(item.card);
                    }
                });
            }

        } catch (err) {
            console.error("Error in loadEmployerApplications:", err);
            alert("Қате! Өтініштерді жүктеу мүмкін болмады.");
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadEmployerApplications();
    });

</script>

<link rel="stylesheet" th:href="@{/css/footer.css}">
<div th:replace="~{navigation :: footer}"></div>
</body>
</html>