<!DOCTYPE html>
<html lang="kk" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Жауаптар беті</title>
    <link rel="stylesheet" th:href="@{/css/response.css}">
</head>
<body>

<div class="tabs">
    <button class="tab active" data-tab="all">Барлығы</button>
    <button class="tab" data-tab="pending">Жауап күтуде</button>
    <button class="tab" data-tab="interview">Шақыру</button>
    <button class="tab" data-tab="interview">Қабылданды</button>
</div>

<div id="all" class="content"><div class="cards"></div></div>
<div id="pending" class="content hidden"><div class="cards"></div></div>
<div id="interv" class="content hidden"><div class="cards"></div></div>
<div id="interview" class="content hidden"><div class="cards"></div></div>

<script>
    const token = localStorage.getItem("token");
    if (!token) {
        alert("Кіру қажет!");
        window.location.href = "/login";
    }

    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.content');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            contents.forEach(c => c.classList.add('hidden'));
            const target = document.getElementById(tab.dataset.tab);
            if (target) target.classList.remove('hidden');
        });
    });

   async function updateStatus(applicationId, newStatus) {
    console.log("ID:", applicationId);
    console.log("STATUS:", newStatus);

    const res = await fetch(`/applications/${applicationId}/status`, {
        method: "PUT",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ status: newStatus })
    });

    console.log("RESPONSE STATUS:", res.status);

    if (!res.ok) {
        const text = await res.text();
        console.log("SERVER RESPONSE:", text);
        throw new Error("Ошибка обновления");
    }

    loadEmployerApplications();
}

    async function loadEmployerApplications() {
        try {
            const res = await fetch("/vacancies/applications/my", {
                headers: { "Authorization": "Bearer " + token }
            });

            const applications = await res.json();

            const statusMap = {
                pending: "pending",
                interview: "interview",
                invited: "invited",
            };

            const containers = {
                all: document.querySelector("#all .cards"),
                pending: document.querySelector("#pending .cards"),
                interview: document.querySelector("#interview .cards"),
                interview: document.querySelector("#interview .cards"),
            };

            Object.values(containers).forEach(c => { if (c) c.innerHTML = ""; });

            if (!applications || applications.length === 0) {
                containers.all.innerHTML = `<h2>Қазіргі уақытта өтініштер жоқ</h2>`;
                return;
            }

            for (const app of applications) {

                const card = document.createElement("div");
                card.className = "application-card";

                let statusText = "";
                if (app.status === "pending") statusText = "Жауап күтуде";
                else if (app.status === "interview") statusText = "Сұхбат";
                else if (app.status === "interview") statusText = "Қабылданды";

                card.innerHTML = `
                    <div class="status-label ${app.status}">${statusText}</div>
                    <h4>${app.vacancyTitle || "Вакансия"}</h4>
                    <p><strong>Қатысушы:</strong> ${app.userName || "Атауы жоқ"}</p>
                    <p>${app.location || ""}</p>
                    <p class="date">${app.appliedAt ? new Date(app.appliedAt).toLocaleDateString("kk-KZ") : ""}</p>

                    ${app.status === "pending" ? `
                        <div class="action-buttons">
                            <button class="accept-btn">Қабылдау</button>
                            <button class="reject-btn">Қабылдамау</button>
                        </div>
                    ` : ""}
                `;

                if (app.status === "pending") {
                card.querySelector(".accept-btn")
                .addEventListener("click", () => updateStatus(app.applicationId, "interview"));

                card.querySelector(".reject-btn")
                .addEventListener("click", () => updateStatus(app.applicationId, "rejected"));
}

                containers.all.appendChild(card);

                const tabId = statusMap[app.status];
                if (tabId && containers[tabId]) {
                    containers[tabId].appendChild(card.cloneNode(true));
                }
            }

        } catch (err) {
            console.error(err);
            alert("Қате! Өтініштерді жүктеу мүмкін болмады.");
        }
    }

    loadEmployerApplications();
</script>

<link rel="stylesheet" th:href="@{/css/footer.css}">
<div th:replace="~{navigation :: footer}"></div>
</body>
</html>
