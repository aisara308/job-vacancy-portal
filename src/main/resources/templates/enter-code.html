<!DOCTYPE html>
<html lang="kk" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>“ö“±–ø–∏—è—Å”©–∑–¥—ñ “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É</title>
    <link rel="stylesheet" th:href="@{/css/login.css}" />
</head>
<body>

<div class="container">

    <h2>“ö“±–ø–∏—è—Å”©–∑–¥—ñ “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É</h2>

    <!-- ===== –ë–ª–æ–∫ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ ===== -->
    <div id="codeSection">
        <input type="text" id="codeInput" placeholder="6 —Ç–∞“£–±–∞–ª—ã –∫–æ–¥">
        <button onclick="verifyCode()" class="login-btn">–¢–µ–∫—Å–µ—Ä—É</button>
    </div>

    <!-- ===== –ë–ª–æ–∫ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è ===== -->
    <div id="passwordSection" style="display:none;">
        <input type="password" id="newPassword" placeholder="–ñ–∞“£–∞ “õ“±–ø–∏—è—Å”©–∑">
        <div style="height:20px"></div>
        <div class="password-field">
            <input type="password" id="confirmPassword" placeholder="“ö“±–ø–∏—è—Å”©–∑–¥—ñ “õ–∞–π—Ç–∞–ª–∞“£—ã–∑">
            <button type="button" class="eye-btn" id="toggleLoginPassword" tabindex="-1">üëÅÔ∏è</button>
        </div>
        <div style="height:20px"></div>
        <button onclick="updatePassword()" class="login-btn">–°–∞“õ—Ç–∞—É</button>
    </div>

</div>

<script>
    const togglePwdLogin = document.getElementById("toggleLoginPassword");
    const pwdInputLogin = document.getElementById("confirmPassword");

    togglePwdLogin.addEventListener("click", () => {
        if (pwdInputLogin.type === "password") {
            pwdInputLogin.type = "text";
        } else {
            pwdInputLogin.type = "password";
        }
    });
        async function verifyCode() {
            const code = document.getElementById("codeInput").value.trim();
            const email = localStorage.getItem("resetEmail");

            if (!code) return alert("–ö–æ–¥ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑");

            const response = await fetch("/verify-reset-code", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, code })
            });

            if (response.ok) {
                // –°–∫—Ä—ã–≤–∞–µ–º –≤–≤–æ–¥ –∫–æ–¥–∞
                document.getElementById("codeSection").style.display = "none";
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø–∞—Ä–æ–ª—è
                document.getElementById("passwordSection").style.display = "block";
            } else {
                alert("–ö–æ–¥ “õ–∞—Ç–µ –Ω–µ–º–µ—Å–µ –º–µ—Ä–∑—ñ–º—ñ ”©—Ç—Ç—ñ");
            }
        }

        async function updatePassword() {
            const email = localStorage.getItem("resetEmail");
            const newPassword = document.getElementById("newPassword").value.trim();
            const confirmPassword = document.getElementById("confirmPassword").value.trim();

            if (!newPassword || !confirmPassword)
                return alert("–ë–∞—Ä–ª—ã“õ ”©—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑");

            if (newPassword !== confirmPassword)
                return alert("“ö“±–ø–∏—è—Å”©–∑–¥–µ—Ä —Å”ô–π–∫–µ—Å –∫–µ–ª–º–µ–π–¥—ñ");

            const response = await fetch("/reset-password-final", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, newPassword })
            });

            if (response.ok) {

        // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏–Ω–∏–º—Å—è
        const loginResponse = await fetch("/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                email: email,
                passwordHash: newPassword
            })
        });

        const loginData = await loginResponse.json();

        if (loginResponse.ok && loginData.token) {
            localStorage.setItem("token", loginData.token);
            localStorage.setItem("userType", loginData.userType);

            if (loginData.userType === "employer") {
                window.location.href = "/homeem";
            } else {
                window.location.href = "/home";
            }
        }

        localStorage.removeItem("resetEmail");
    } else {
                alert("“ö–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã");
            }
        }

</script>

</body>
</html>