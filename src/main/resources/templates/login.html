<!DOCTYPE html>
<html lang="kk" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ö—ñ—Ä—É</title>
    <link rel="stylesheet" th:href="@{/css/login.css}" />
</head>
<body>
<div class="container">
    <h1>–ö—ñ—Ä—É</h1>

    <form class="login-form" onsubmit="login(event)">
        <input type="text" name="email" placeholder="email" required />
        <div class="password-field">
            <input type="password" name="password" placeholder="“ö“±–ø–∏—è—Å”©–∑" required id="loginPassword">
            <button type="button" class="eye-btn" id="toggleLoginPassword" tabindex="-1">üëÅÔ∏è</button>
        </div>

        <a href="#" class="forgot-link" onclick="openResetModal()">“ö“±–ø–∏—è—Å”©–∑–¥—ñ “±–º—ã—Ç—Ç—ã“£—ã–∑ –±–∞?</a>

        <button type="submit" class="login-btn">–ö—ñ—Ä—É</button>
    </form>

    <div class="divider">
        <span>–ù–µ–º–µ—Å–µ</span>
    </div>

    <p class="signup-text">
        –ê–∫–∫–∞—É–Ω—Ç –∂–æ“õ –ø–∞? <a href="/register" class="signup-link">–¢—ñ—Ä–∫–µ–ª—É</a>
    </p>
</div>
<script>

    async function login(event) {
  event.preventDefault();

  const user = {
    email: document.querySelector('input[name="email"]').value,
    passwordHash: document.querySelector('input[name="password"]').value
  };

  try {
    const response = await fetch("/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(user)
    });

    const data = await response.json();
    const token = data.token;

    if (response.ok && token && token !== "fail") {
      localStorage.setItem("token", token);
      localStorage.setItem("userType", data.userType);
      if (data.userType === "employer") {
        window.location.href = "/homeem";
        }
      else if (data.userType === "applicant"){
        window.location.href = "/home";
        }
    } else {
      alert(data.message || "“ö–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã!");
    }
  } catch (err) {
    console.error(err);
    alert("–°–µ—Ä–≤–µ—Ä–≥–µ “õ–æ—Å—ã–ª—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã");
  }
}
function openResetModal() {
  document.getElementById("resetModal").style.display = "flex";
}

function closeResetModal() {
  document.getElementById("resetModal").style.display = "none";
}

async function sendResetCodeModal() {
    const email = document.getElementById("resetEmailModal").value.trim();
    if (!email) return alert("–ü–æ—á—Ç—É –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑");

    try {
        const response = await fetch("/send-reset-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email })
        });

        if (response.ok) {
            localStorage.setItem("resetEmail", email);
            window.location.href = "/enter-code";
        } else if (response.status === 404) {
            alert("–ü–æ—à—Ç–∞ —Ç–∞–±—ã–ª–º–∞–¥—ã.");
        } else {
            const err = await response.text();
            alert("“ö–∞—Ç–µ: " + err);
        }
    } catch (err) {
        console.error(err);
        alert("–°–µ—Ä–≤–µ—Ä–º–µ–Ω –±–∞–π–ª–∞–Ω—ã—Å –∂–æ“õ.");
    }
}
    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å
const togglePwdLogin = document.getElementById("toggleLoginPassword");
const pwdInputLogin = document.getElementById("loginPassword");

togglePwdLogin.addEventListener("click", () => {
    if (pwdInputLogin.type === "password") {
        pwdInputLogin.type = "text";
    } else {
        pwdInputLogin.type = "password";
    }
});

// –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å
document.getElementById("forgotPasswordLink").addEventListener("click", (e) => {
    e.preventDefault();
    document.getElementById("resetPasswordDiv").style.display = "block";
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–±—Ä–æ—Å
document.getElementById("sendReset").addEventListener("click", async () => {
    const email = document.getElementById("resetEmail").value.trim();
    if (!email) return alert("–ü–æ—á—Ç—É –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑");

    try {
        const response = await fetch("/reset-password", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email })
        });

        if (response.ok) {
            alert("–°—ñ–ª—Ç–µ–º–µ –ø–æ—à—Ç–∞“ì–∞ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ –Ω–µ–º–µ—Å–µ —É–∞“õ—ã—Ç—à–∞ –ø–∞—Ä–æ–ª—å –æ—Ä–Ω–∞—Ç—ã–ª–¥—ã.");
            document.getElementById("resetPasswordDiv").style.display = "none";
        } else {
            const err = await response.text();
            alert("“ö–∞—Ç–µ: " + err);
        }
    } catch (err) {
        console.error(err);
        alert("–°–µ—Ä–≤–µ—Ä–º–µ–Ω –±–∞–π–ª–∞–Ω—ã—Å –∂–æ“õ.");
    }
});
</script>
<div id="resetModal" class="modal">
    <div class="modal-content">
        <h3>“ö“±–ø–∏—è—Å”©–∑–¥—ñ “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É</h3>
        <input type="email" id="resetEmailModal" placeholder="–ü–æ—à—Ç–∞–Ω—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑">
        <button onclick="closeResetModal()" class="modal-btn">–ñ–∞–±—É</button>
        <button onclick="sendResetCodeModal()" class="modal-btn">–ö–æ–¥ –∂—ñ–±–µ—Ä—É</button>
    </div>
</div>
</body>
</html>
