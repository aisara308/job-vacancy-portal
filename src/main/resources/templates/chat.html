<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>Чат</title>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        body { font-family: Arial; margin: 0; }
        .chat-container { height: 90vh; display: flex; flex-direction: column; }
        .messages { flex: 1; overflow-y: auto; padding: 15px; }
        .message { margin-bottom: 10px; padding: 8px; background-color: #f1f1f1; border-radius: 5px; }
        .my-message { background-color: #dcf8c6; text-align: right; }
        .input-area { display: flex; padding: 10px; border-top: 1px solid #ccc; }
        input { flex: 1; padding: 8px; }
        button { padding: 8px 15px; }
    </style>
</head>
<body>

<div class="chat-container">
    <div id="messages" class="messages"></div>

    <div class="input-area">
        <input type="text" id="messageInput" placeholder="Хабар жазу...">
        <button onclick="sendMessage()">Жіберу</button>
    </div>
</div>

<script>
    const chatId = [[${chatId}]];
    const token = localStorage.getItem("token");

    // Для отладки
    console.log("Chat ID:", chatId);
    console.log("Token:", token ? "есть" : "нет");

    if (!token) {
        alert("Сіз жүйеге кірмегенсіз. Бетті жаңартып, кіріңіз.");
        // Перенаправление на страницу входа
        window.location.href = "/login";
    }

    let stompClient = null;
    let currentUserEmail = null;

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        // Отключаем логирование STOMP (для чистоты консоли)
        stompClient.debug = null;

        // Заголовки с токеном
        const headers = {
            'Authorization': 'Bearer ' + token
        };

        stompClient.connect(headers, function (frame) {
            console.log("WebSocket подключен успешно");

            // Подписываемся на чат
            stompClient.subscribe(`/topic/chat.${chatId}`, function (message) {
                const msg = JSON.parse(message.body);
                showMessage(msg);
            });

            // Получаем информацию о текущем пользователе
            getUserInfo();

        }, function (error) {
            console.error("Ошибка подключения к WebSocket:", error);
            alert("Не удалось подключиться к чату. Проверьте подключение к интернету.");
        });
    }

    function getUserInfo() {
        // Получаем информацию о текущем пользователе через REST API
        fetch('/api/user', {
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
        .then(response => response.json())
        .then(data => {
            currentUserEmail = data.email;
            console.log("Текущий пользователь:", currentUserEmail);
        })
        .catch(error => {
            console.error("Ошибка получения информации о пользователе:", error);
        });
    }

    function sendMessage() {
        const input = document.getElementById("messageInput");
        const content = input.value;

        if (!content.trim()) return;

        if (!stompClient || !stompClient.connected) {
            alert("Нет подключения к серверу");
            return;
        }

        console.log("Отправка сообщения:", { chatId: chatId, content: content });

        stompClient.send("/app/chat.send", {}, JSON.stringify({
            chatId: chatId,
            content: content
        }));

        input.value = "";
    }

function showMessage(msg) {
    const container = document.getElementById("messages");

    const div = document.createElement("div");
    div.className = "message";

    // Используем поля из DTO
    let senderName = msg.senderName || msg.senderEmail || "Неизвестный";

    // Добавляем класс для своих сообщений
    if (currentUserEmail && msg.senderEmail === currentUserEmail) {
        div.classList.add("my-message");
    }

    // Форматируем время если есть
    let timeStr = "";
    if (msg.sentAt) {
        try {
            const time = new Date(msg.sentAt);
            timeStr = ` [${time.getHours()}:${time.getMinutes().toString().padStart(2, '0')}]`;
        } catch (e) {
            console.log("Ошибка парсинга даты:", e);
        }
    }

    div.innerText = senderName + timeStr + ": " + msg.content;

    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

    // Подключаемся при загрузке страницы
    window.onload = function() {
        connect();
    };
</script>

</body>
</html>