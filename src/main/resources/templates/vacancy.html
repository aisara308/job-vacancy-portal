<!DOCTYPE html>
<html lang="kk" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Вакансия қосу</title>
    <link rel="stylesheet" th:href="@{/css/resume.css}">
</head>
<body>
<div class="resume-container">
    <h2>Вакансия қосу</h2>
    <form id="vacancyForm" class="resume-form">
        <label>Атауы</label>
        <input type="text" name="title" placeholder="Мысалы: Java Developer" required>

        <label>Жалақыдан</label>
        <input type="number" step="0.01" name="salaryFrom">

        <label>Жалақыға дейін</label>
        <input type="number" step="0.01" name="salaryTo">

        <label>Тәжірибе</label>
        <input type="text" name="experience">

        <label>Орналасқан жері</label>
        <input type="text" name="location">

        <label>Адрес</label>
        <input type="text" name="adres">

        <label>Жұмыс кестесі</label>
        <input type="text" name="schedule">

        <label>Төлем мерзімі</label>
        <input type="text" name="paymentTime">

        <label>
            Қашықтан:
            <input type="checkbox" name="remote" value="true">
        </label>

        <label>
            Студенттер үшін:
            <input type="checkbox" name="forStudents" value="true">
        </label>

        <label>Талаптар</label>
        <textarea name="requirements" rows="4"></textarea>

        <button type="submit" class="create-btn">Құру</button>
    </form>
</div>

<script>
    document.getElementById("vacancyForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const token = localStorage.getItem("token");
        if (!token) {
            alert("Кіру қажет!");
            window.location.href = "/login";
            return;
        }

        try {
            const userRes = await fetch("/api/user", {
                headers: { "Authorization": "Bearer " + token },
            });

            if (!userRes.ok) {
                alert("Қолданушы табылмады немесе токен жарамсыз!");
                return;
            }

            const user = await userRes.json();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            // Преобразование типов
            data.remote = !!data.remote;
            data.forStudents = !!data.forStudents;
            if (data.salaryFrom) data.salaryFrom = parseFloat(data.salaryFrom);
            if (data.salaryTo) data.salaryTo = parseFloat(data.salaryTo);

            data.employerId = user.userId; // связываем с пользователем

            const res = await fetch("/vacancies/add", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify(data),
            });

            if (res.ok) {
                window.location.href = "/profileem";
            } else {
                const text = await res.text();
                alert("Қате: " + text);
            }

        } catch (err) {
            console.error("Қате:", err);
            alert("Сервер қатесі немесе желіде ақау бар");
        }
    });

</script>
</body>
</html>
